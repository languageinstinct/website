---
/**
 * Responsive Image component
 * - Works with /public/images and /src/images
 * - Scales dynamically with window size
 * - No captions under images
 */

import { getImage, type ImageTransform } from "astro:assets";
import { readFile } from "node:fs/promises";
import { getPlaiceholder } from "plaiceholder";
import type { ImageMetadata } from "astro";

const SRC_IMAGES_PREFIX = "/src/";
const PUBLIC_IMAGES_PREFIX = "/images/";
const WIDE_CONTAINER_WIDTH = 1000;

const props = Astro.props;
const { loading = "lazy", decoding = "async" } = props;

let src = props.src;
let importedImage = null;
let placeholder = null;
let width = props.width;
let height = props.height;

// ✅ Use static paths for /public/images
if (typeof src === "string" && src.startsWith(PUBLIC_IMAGES_PREFIX)) {
  // serve directly
} else {
  // ✅ Handle /src/images imports
  const pathToImage = decodeURIComponent(
    src.startsWith("/") ? `../../../src${src}` : src
  );

  const allImages = import.meta.glob<false, string, { default: ImageMetadata }>(
    "../../../src/images/**/*"
  );

  try {
    importedImage = (await allImages[pathToImage.replace("../src/", "")]!())
      .default;
  } catch {
    // skip errors for non-src paths
  }

  if (importedImage) {
    ({ src } = await getImage({
      src: importedImage,
      format: "webp",
      width: width ?? WIDE_CONTAINER_WIDTH,
      height,
    } as ImageTransform));
  }

  try {
    const imageForPlaceholder = await readFile(new URL(pathToImage, import.meta.url));
    const { css } = await getPlaiceholder(imageForPlaceholder, { size: 10 });
    placeholder = css;
  } catch {
    // placeholder optional
  }
}
---

<div class="relative flex flex-col items-center my-6 w-full">
  <div
    class:list={[
      "overflow-hidden rounded-md shadow-md w-full",
      "bg-neutral-100 dark:bg-neutral-800",
      placeholder && "relative"
    ]}
  >
    <img
      src={src}
      alt=""
      class="object-cover w-full h-auto transition-transform duration-300 hover:scale-[1.02] sm:rounded-lg md:max-w-4xl lg:max-w-6xl mx-auto"
      loading={loading}
      decoding={decoding}
    />
    {
      placeholder && (
        <span
          style={placeholder}
          class="absolute inset-0 -z-10 h-full w-full scale-150 blur-2xl opacity-80"
        />
      )
    }
  </div>
</div>
